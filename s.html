<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Fest 2025 - Tournament Brackets</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="config.js"></script>
    <script src="config2.js"></script>

    <style>
        :root {
            --primary: #003366; /* Oxford Blue */
            --secondary: #b8860b; /* Dark Goldenrod */
            --bg-page: #f4f6f9;
            --connector: #94a3b8;
            --card-width: 220px;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-page);
            margin: 0; padding: 20px;
            color: #1f2937;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a237e 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-title h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .header-title p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

        /* Controls */
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .custom-select {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 12px; border-radius: 6px; outline: none;
        }
        .custom-select option { background: var(--primary); color: white; }
        
        .btn {
            padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;
            display: flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: transform 0.1s;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-excel { background: #107c41; color: white; }
        .btn-pdf { background: #cf2e2e; color: white; }
        .btn-toggle { background: white; color: var(--primary); }

        /* Bracket View */
        .bracket-scroll {
            overflow-x: auto;
            padding: 40px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-height: 600px;
            position: relative;
        }
        .bracket-tree { display: flex; }
        
        .round {
            display: flex; flex-direction: column; justify-content: space-around;
            min-width: var(--card-width); margin-right: 80px; position: relative;
        }
        .round-title {
            position: absolute; top: -35px; width: 100%; text-align: center;
            font-weight: 700; color: #6b7280; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
        }

        /* Match Card */
        .match-wrapper { position: relative; margin: 10px 0; display: flex; align-items: center; }
        .match-card {
            background: white; border: 1px solid #d1d5db; border-radius: 6px;
            width: 100%; position: relative; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .match-card:hover { border-color: var(--primary); }

        .team {
            padding: 6px 10px; display: flex; justify-content: space-between;
            font-size: 0.85rem; height: 32px; align-items: center;
        }
        .team:first-child { border-bottom: 1px solid #f3f4f6; }
        .team.winner { background-color: #eef2ff; font-weight: 700; color: var(--primary); }
        .team-score { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; min-width: 20px; text-align: center; }
        .team.winner .team-score { background: var(--primary); color: white; }

        /* Connectors */
        .match-wrapper::after {
            content: ''; position: absolute; right: -40px; width: 40px; height: 2px;
            background: var(--connector); top: 50%;
        }
        .round:last-child .match-wrapper::after { display: none; }
        
        .connector-vertical {
            position: absolute; right: -40px; width: 2px; background: var(--connector); z-index: 1;
        }
        .connector-vertical::after {
            content: ''; position: absolute; top: 50%; left: 0; width: 40px; height: 2px; background: var(--connector);
        }

        /* Table View */
        #data-view { display: none; background: white; padding: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background: #f9fafb; }

        /* Loading & Print */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            .dashboard-header, .btn, .custom-select { display: none; }
            .bracket-scroll { overflow: visible; padding: 0; box-shadow: none; }
            .match-wrapper::after, .connector-vertical, .connector-vertical::after {
                background: #666 !important; -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#666;">Loading Tournament Data...</p>
    </div>

    <div class="dashboard-header">
        <div class="header-title">
            <h1>Sports Fest 2025</h1>
            <p>Tournament Bracket Viewer</p>
        </div>
        
        <div class="controls">
            <select id="sportFilter" class="custom-select" onchange="loadBracketData()">
                <option value="">Loading Sports...</option>
            </select>
            <select id="categoryFilter" class="custom-select" onchange="loadBracketData()">
                <option value="">Loading Categories...</option>
            </select>
        </div>

        <div class="controls">
            <button class="btn btn-toggle" onclick="toggleView()">üìä List View</button>
            <button class="btn btn-excel" onclick="exportExcel()">üìó Excel</button>
            <button class="btn btn-pdf" onclick="printPDF()">üìï PDF</button>
        </div>
    </div>

    <div class="bracket-scroll" id="bracket-view">
        <div class="bracket-tree" id="bracket-root"></div>
    </div>

    <div id="data-view">
        <h2>Schedule & Results</h2>
        <table id="match-table">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Team A</th>
                    <th>Team B</th>
                    <th>Winner</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

<script>
    // ============================================
    // 1. SAFE CONFIGURATION CHECK
    // ============================================
    let db; // Renamed from 'supabase' to avoid conflict
    
    try {
        if (typeof CONFIG === 'undefined' || !CONFIG.supabaseUrl) {
            throw new Error("Configuration file (config.js) not found or invalid.");
        }
        // Initialize Client using global window.supabase object
        db = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
    } catch (err) {
        document.getElementById('loading').innerHTML = `<p style="color:red; font-weight:bold;">Error: ${err.message}</p>`;
        throw err; // Stop execution
    }

    let allMatches = [];
    const ROUND_NAMES = { 1: "Finals", 2: "Semi-Finals", 3: "Quarter-Finals", 4: "Round of 16", 5: "Round of 32" };

    // ============================================
    // 2. INITIALIZATION
    // ============================================
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            await initFilters();
        } catch (err) {
            console.error(err);
            alert("Error loading initial data: " + err.message);
            document.getElementById('loading').style.display = 'none';
        }
    });

    async function initFilters() {
        // Fetch Sports
        const { data: sports, error: err1 } = await db.from('sports').select('id, name');
        if (err1) throw err1;

        const sSelect = document.getElementById('sportFilter');
        sSelect.innerHTML = '<option value="">Select Sport...</option>';
        if (sports) sports.forEach(s => {
            sSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });

        // Fetch Categories (Match Types)
        const { data: matches, error: err2 } = await db.from('matches').select('match_type');
        if (err2) throw err2;

        const cSelect = document.getElementById('categoryFilter');
        cSelect.innerHTML = '<option value="">Select Category...</option>';
        const distinctCats = [...new Set(matches.map(m => m.match_type).filter(Boolean))].sort();
        
        distinctCats.forEach(c => {
            cSelect.innerHTML += `<option value="${c}">${c}</option>`;
        });

        // Auto Select if data exists
        if(sports.length > 0) sSelect.value = sports[0].id;
        if(distinctCats.length > 0) cSelect.value = distinctCats[0];

        // Load Bracket
        loadBracketData();
    }

    // ============================================
    // 3. FETCH & RENDER LOGIC
    // ============================================
    async function loadBracketData() {
        const sportId = document.getElementById('sportFilter').value;
        const cat = document.getElementById('categoryFilter').value;
        
        if(!sportId && !cat) {
            document.getElementById('loading').style.display = 'none';
            return;
        }

        document.getElementById('loading').style.display = 'flex';

        // Fetch Matches
        let query = db.from('matches').select('*')
            .order('round_number', { ascending: true })
            .order('id', { ascending: true });

        if(sportId) query = query.eq('sport_id', sportId);
        if(cat) query = query.eq('match_type', cat);

        const { data, error } = await query;
        document.getElementById('loading').style.display = 'none';

        if(error) {
            console.error(error);
            alert("Error loading matches.");
            return;
        }

        allMatches = data;
        renderBracket(data);
        renderTable(data);
    }

    function renderBracket(matches) {
        const root = document.getElementById('bracket-root');
        root.innerHTML = '';
        
        if(!matches.length) {
            root.innerHTML = '<div style="padding:20px;">No matches found.</div>';
            return;
        }

        // Group by Round
        const rounds = {};
        let maxRound = 0;
        matches.forEach(m => {
            if(!rounds[m.round_number]) rounds[m.round_number] = [];
            rounds[m.round_number].push(m);
            if(m.round_number > maxRound) maxRound = m.round_number;
        });

        // Loop Rounds (Assume 1 -> Max)
        for(let r = 1; r <= maxRound; r++) {
            if(!rounds[r]) continue;

            const roundDiv = document.createElement('div');
            roundDiv.className = 'round';
            
            // Round Name Logic
            const rFromFinal = maxRound - r + 1;
            const rName = ROUND_NAMES[rFromFinal] || `Round ${r}`;
            
            roundDiv.innerHTML = `<div class="round-title">${rName}</div>`;

            rounds[r].forEach((m, i) => {
                const isPairStart = (i % 2 === 0);
                
                // Safe name handling
                const t1 = (m.team1_name || "TBD").substring(0,14);
                const t2 = (m.team2_name || "TBD").substring(0,14);
                
                // Winner Check
                const w1 = (m.winner_id && m.winner_id == m.team1_id) ? 'winner' : '';
                const w2 = (m.winner_id && m.winner_id == m.team2_id) ? 'winner' : '';

                const card = `
                <div class="match-wrapper" id="m-${m.id}" data-pair="${isPairStart}">
                    <div class="match-card">
                        <div class="team ${w1}">
                            <span>${t1}</span><span class="team-score">${m.score1 || 0}</span>
                        </div>
                        <div class="team ${w2}">
                            <span>${t2}</span><span class="team-score">${m.score2 || 0}</span>
                        </div>
                    </div>
                </div>`;
                
                roundDiv.insertAdjacentHTML('beforeend', card);
            });
            root.appendChild(roundDiv);
        }

        // Add Champion (If final is played)
        if(rounds[maxRound] && rounds[maxRound].length === 1) {
            const final = rounds[maxRound][0];
            if(final.status === 'Completed' && final.winner_id) {
                const champName = final.winner_id == final.team1_id ? final.team1_name : final.team2_name;
                const champHTML = `
                <div class="round" style="justify-content:center;">
                    <div class="round-title" style="color:#b8860b;">CHAMPION</div>
                    <div class="match-wrapper">
                        <div class="match-card" style="border-color:#b8860b; box-shadow:0 0 10px rgba(184,134,11,0.2);">
                            <div class="team winner" style="justify-content:center; height:50px; background:white; color:#b8860b;">
                                üèÜ ${champName}
                            </div>
                        </div>
                    </div>
                </div>`;
                root.insertAdjacentHTML('beforeend', champHTML);
            }
        }

        // Draw Lines
        setTimeout(drawConnectors, 50);
    }

    // ============================================
    // 4. CONNECTOR DRAWING
    // ============================================
    function drawConnectors() {
        document.querySelectorAll('.connector-vertical').forEach(el => el.remove());
        
        const root = document.getElementById('bracket-root');
        const rootRect = root.getBoundingClientRect();
        
        // Find all pair starters
        const pairs = document.querySelectorAll('[data-pair="true"]');
        
        pairs.forEach(startEl => {
            const nextEl = startEl.nextElementSibling;
            if(!nextEl || !nextEl.classList.contains('match-wrapper')) return;

            // Geometry
            const r1 = startEl.getBoundingClientRect();
            const r2 = nextEl.getBoundingClientRect();
            
            const y1 = (r1.top + r1.height/2) - rootRect.top;
            const y2 = (r2.top + r2.height/2) - rootRect.top;
            const h = y2 - y1;

            // Create Line
            const line = document.createElement('div');
            line.className = 'connector-vertical';
            line.style.height = `${h}px`;
            line.style.top = '50%';
            
            // Only add if next column exists (not for champion box)
            if(startEl.closest('.round').nextElementSibling) {
                startEl.appendChild(line);
            }
        });
    }

    // Redraw on resize
    window.addEventListener('resize', drawConnectors);

    // ============================================
    // 5. UTILITIES
    // ============================================
    function renderTable(data) {
        const body = document.getElementById('table-body');
        body.innerHTML = '';
        data.forEach(m => {
            const wName = m.winner_id ? (m.winner_id == m.team1_id ? m.team1_name : m.team2_name) : '-';
            const row = `
            <tr>
                <td>Round ${m.round_number}</td>
                <td>${m.team1_name || 'TBD'}</td>
                <td>${m.team2_name || 'TBD'}</td>
                <td style="font-weight:bold; color:var(--primary);">${wName}</td>
                <td>${m.status}</td>
            </tr>`;
            body.innerHTML += row;
        });
    }

    function toggleView() {
        const v = document.getElementById('bracket-view');
        const d = document.getElementById('data-view');
        const btn = document.querySelector('.btn-toggle');
        
        if(v.style.display === 'none') {
            v.style.display = 'block'; d.style.display = 'none';
            btn.innerHTML = 'üìä List View';
            setTimeout(drawConnectors, 50);
        } else {
            v.style.display = 'none'; d.style.display = 'block';
            btn.innerHTML = 'üå≥ Bracket View';
        }
    }

    function printPDF() {
        document.getElementById('bracket-view').style.display = 'block';
        document.getElementById('data-view').style.display = 'none';
        window.print();
    }

    function exportExcel() {
        let html = '<table border="1"><thead><tr><th>Round</th><th>Team A</th><th>Team B</th><th>Winner</th></tr></thead><tbody>';
        allMatches.forEach(m => {
            const wName = m.winner_id ? (m.winner_id == m.team1_id ? m.team1_name : m.team2_name) : '-';
            html += `<tr><td>${m.round_number}</td><td>${m.team1_name}</td><td>${m.team2_name}</td><td>${wName}</td></tr>`;
        });
        html += '</tbody></table>';
        
        const a = document.createElement('a');
        a.href = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
        a.download = 'Tournament_Schedule.xls';
        a.click();
    }
</script>
</body>
</html>
